<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myInsa">
	
	<!-- 인사관리 -->
	<select id="readProfile" parameterType="long" resultType="com.sp.grooveware.myInsa.MyInsa">
		SELECT e.emp_no, e.emp_name, e.emp_email, e.emp_tel, 
				d.dept_name, p.pos_name,
				TO_CHAR(e.emp_join_date, 'YYYY-MM-DD') emp_join_date, emp_picture,
				emp_zip, emp_addr1, emp_addr2
		FROM emp e
		JOIN (
		    SELECT *
		    FROM emp_history
		    WHERE emp_no = #{emp_no}
		    ORDER BY dept_startdate DESC
		    FETCH FIRST 1 ROW ONLY
		) eh ON e.emp_no = eh.emp_no
		JOIN dept d ON eh.dept_no = d.dept_no
		JOIN pos p ON eh.pos_no = p.pos_no
		WHERE e.emp_no = #{emp_no}
	</select>
	
	<select id="readAnnualLeave" parameterType="long" resultType="Integer">
		SELECT TRUNC((MONTHS_BETWEEN(TRUNC(SYSDATE), TRUNC(e.emp_join_date)) / 12 ) + 1) AS annual_leave
		FROM emp e
		WHERE e.emp_no = #{emp_no}
	</select>
	
	<!-- 인사관리 -->
	<select id="readProfile2" parameterType="long" resultType="com.sp.grooveware.myInsa.MyInsa">
		SELECT e.emp_no, e.emp_name, e.emp_email, e.emp_tel,
				d.dept_name, p.pos_name,
				SUBSTR(emp_rrn, 1, 6) emp_rrn,
				TO_CHAR(e.emp_join_date, 'YYYY-MM-DD') emp_join_date, emp_picture,
				emp_zip, emp_addr1, emp_addr2
		FROM emp e
		JOIN (
		    SELECT *
		    FROM emp_history
		    WHERE emp_no = #{emp_no}
		    ORDER BY dept_startdate DESC
		    FETCH FIRST 1 ROW ONLY
		) eh ON e.emp_no = eh.emp_no
		JOIN dept d ON eh.dept_no = d.dept_no
		JOIN pos p ON eh.pos_no = p.pos_no
		WHERE e.emp_no = #{emp_no}
	</select>
	
	<!-- 사원 정보 update -->
	<update id="updateProfile" parameterType="com.sp.grooveware.myInsa.MyInsa">
		UPDATE emp 
		SET emp_email = #{emp_email}, emp_address = #{emp_address}, 
			emp_tel = #{emp_tel}, emp_zip = #{emp_zip}, emp_addr1 = #{emp_addr1}, emp_addr2 = #{emp_addr2}
		WHERE emp_no = #{emp_no}
	</update>

</mapper>